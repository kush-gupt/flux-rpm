name: Build and Test RPMs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILDER_IMAGE: ghcr.io/${{ github.repository }}/flux-rpm-builder:latest

jobs:
  lint:
    name: Lint spec files
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install and run rpmlint
        run: |
          dnf install -y rpmlint
          rpmlint flux-security/flux-security.spec || true
          rpmlint flux-core/flux-core.spec || true
          rpmlint flux-sched/flux-sched.spec || true
          rpmlint flux-accounting/flux-accounting.spec || true

  # Check container availability (fast, parallel)
  check-container:
    name: Check container
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.check.outputs.image }}
    steps:
      - id: check
        run: |
          if docker manifest inspect ${{ env.BUILDER_IMAGE }} > /dev/null 2>&1; then
            echo "image=${{ env.BUILDER_IMAGE }}" >> $GITHUB_OUTPUT
          else
            echo "image=fedora:latest" >> $GITHUB_OUTPUT
          fi

  # Build SRPMs (no lint dependency for faster startup)
  build-srpms:
    name: Build SRPMs
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Build all SRPMs
        run: |
          dnf install -y rpm-build rpmdevtools wget
          rpmdev-setuptree
          
          # Get versions
          SEC_VER=$(grep '^Version:' flux-security/flux-security.spec | awk '{print $2}')
          CORE_VER=$(grep '^Version:' flux-core/flux-core.spec | awk '{print $2}')
          SCHED_VER=$(grep '^Version:' flux-sched/flux-sched.spec | awk '{print $2}')
          ACCT_VER=$(grep '^Version:' flux-accounting/flux-accounting.spec | awk '{print $2}')
          
          # Download sources in parallel
          wget -q -O ~/rpmbuild/SOURCES/flux-security-${SEC_VER}.tar.gz \
            https://github.com/flux-framework/flux-security/releases/download/v${SEC_VER}/flux-security-${SEC_VER}.tar.gz &
          wget -q -O ~/rpmbuild/SOURCES/flux-core-${CORE_VER}.tar.gz \
            https://github.com/flux-framework/flux-core/releases/download/v${CORE_VER}/flux-core-${CORE_VER}.tar.gz &
          wget -q -O ~/rpmbuild/SOURCES/flux-sched-${SCHED_VER}.tar.gz \
            https://github.com/flux-framework/flux-sched/releases/download/v${SCHED_VER}/flux-sched-${SCHED_VER}.tar.gz &
          wget -q -O ~/rpmbuild/SOURCES/flux-accounting-${ACCT_VER}.tar.gz \
            https://github.com/flux-framework/flux-accounting/releases/download/v${ACCT_VER}/flux-accounting-${ACCT_VER}.tar.gz &
          wait
          
          # Copy specs and patches
          cp flux-security/flux-security.spec ~/rpmbuild/SPECS/
          cp flux-core/flux-core.spec ~/rpmbuild/SPECS/
          cp flux-sched/flux-sched.spec ~/rpmbuild/SPECS/
          cp flux-accounting/flux-accounting.spec ~/rpmbuild/SPECS/
          cp flux-security/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-core/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-sched/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-accounting/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          
          # Build SRPMs
          rpmbuild -bs ~/rpmbuild/SPECS/flux-security.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-core.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-sched.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-accounting.spec
          
          # Move to workspace for upload
          mkdir -p srpms
          mv ~/rpmbuild/SRPMS/*.src.rpm srpms/
      - uses: actions/upload-artifact@v4
        with:
          name: srpms
          path: srpms/

  # Build all packages for each distro in a single job
  # This eliminates job startup overhead and artifact transfer between packages
  build-all:
    name: Build (${{ matrix.distro }})
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container]
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora-41
            mock-release: fedora-41-x86_64
            short-name: f41
          - distro: fedora-42
            mock-release: fedora-42-x86_64
            short-name: f42
          - distro: centos-9
            mock-release: centos-stream+epel-9-x86_64
            short-name: el9
          - distro: centos-10
            mock-release: centos-stream+epel-10-x86_64
            short-name: el10
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Download SRPMs
        uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms

      - name: Restore mock cache
        uses: actions/cache@v4
        with:
          path: /var/cache/mock
          key: mock-${{ matrix.mock-release }}-${{ hashFiles('flux-*/*.spec') }}
          restore-keys: |
            mock-${{ matrix.mock-release }}-

      - name: List SRPMs
        run: ls -la ./srpms/

      - name: Initialize mock
        run: mock -r ${{ matrix.mock-release }} --init

      # ============================================================
      # Build flux-security
      # ============================================================
      - name: Build flux-security
        run: |
          set -o pipefail
          mock -r ${{ matrix.mock-release }} --no-clean --rebuild srpms/flux-security-*.src.rpm --resultdir=results-security 2>&1 | tee security-build.log

      - name: Install flux-security in mock
        run: |
          SECURITY_RPM=$(ls results-security/flux-security-[0-9]*.x86_64.rpm | head -1)
          SECURITY_DEVEL_RPM=$(ls results-security/flux-security-devel-*.x86_64.rpm | head -1)
          echo "Installing: $SECURITY_RPM $SECURITY_DEVEL_RPM"
          # Disable root_cache to preserve chroot state from build
          mock -r ${{ matrix.mock-release }} --disable-plugin=root_cache --install "$SECURITY_RPM" "$SECURITY_DEVEL_RPM"

      # ============================================================
      # Build flux-core
      # ============================================================
      - name: Build flux-core
        run: |
          set -o pipefail
          mock -r ${{ matrix.mock-release }} --disable-plugin=root_cache --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results-core 2>&1 | tee core-build.log

      - name: Install flux-core in mock
        run: |
          CORE_RPM=$(ls results-core/flux-core-[0-9]*.x86_64.rpm | head -1)
          CORE_DEVEL_RPM=$(ls results-core/flux-core-devel-*.x86_64.rpm | head -1)
          PYTHON_RPM=$(ls results-core/python3-flux-[0-9]*.x86_64.rpm | head -1)
          echo "Installing: $CORE_RPM $CORE_DEVEL_RPM $PYTHON_RPM"
          # Disable root_cache to preserve chroot state from build
          mock -r ${{ matrix.mock-release }} --disable-plugin=root_cache --install "$CORE_RPM" "$CORE_DEVEL_RPM" "$PYTHON_RPM"

      # ============================================================
      # Build flux-sched and flux-accounting (both depend on core)
      # ============================================================
      - name: Build flux-sched
        run: |
          set -o pipefail
          mock -r ${{ matrix.mock-release }} --disable-plugin=root_cache --no-clean --rebuild srpms/flux-sched-*.src.rpm --resultdir=results-sched 2>&1 | tee sched-build.log

      - name: Build flux-accounting
        run: |
          set -o pipefail
          mock -r ${{ matrix.mock-release }} --disable-plugin=root_cache --no-clean --rebuild srpms/flux-accounting-*.src.rpm --resultdir=results-accounting 2>&1 | tee accounting-build.log

      # ============================================================
      # Generate summary and upload artifacts
      # ============================================================
      - name: Generate build summary
        if: always()
        run: |
          echo "=== Build Summary for ${{ matrix.mock-release }} ===" | tee build-summary.txt
          echo "Build completed: $(date)" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "=== flux-security packages ===" >> build-summary.txt
          ls -la results-security/*.rpm 2>/dev/null | grep -v debuginfo >> build-summary.txt || echo "No packages" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "=== flux-core packages ===" >> build-summary.txt
          ls -la results-core/*.rpm 2>/dev/null | grep -v debuginfo >> build-summary.txt || echo "No packages" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "=== flux-sched packages ===" >> build-summary.txt
          ls -la results-sched/*.rpm 2>/dev/null | grep -v debuginfo >> build-summary.txt || echo "No packages" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "=== flux-accounting packages ===" >> build-summary.txt
          ls -la results-accounting/*.rpm 2>/dev/null | grep -v debuginfo >> build-summary.txt || echo "No packages" >> build-summary.txt

      - name: Upload all build results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-${{ matrix.short-name }}
          path: |
            results-security/
            results-core/
            results-sched/
            results-accounting/
            *-build.log
            build-summary.txt

      - name: Cleanup mock
        if: always()
        run: mock -r ${{ matrix.mock-release }} --clean
