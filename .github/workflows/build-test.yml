name: Build and Test RPMs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  # Use pre-built container for faster builds
  # Falls back to fedora:latest if container not yet built
  BUILDER_IMAGE: ghcr.io/${{ github.repository }}/flux-rpm-builder:latest

jobs:
  # ============================================================
  # STAGE 1: Lint and validate spec files
  # ============================================================
  lint:
    name: Lint spec files
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install rpmlint
        run: dnf install -y rpmlint

      - name: Run rpmlint on flux-security
        run: rpmlint flux-security/flux-security.spec || true

      - name: Run rpmlint on flux-core
        run: rpmlint flux-core/flux-core.spec || true

  # ============================================================
  # STAGE 2: Build source RPMs
  # ============================================================
  build-srpm:
    name: Build SRPMs
    runs-on: ubuntu-latest
    needs: lint
    container:
      image: fedora:latest
    outputs:
      security-version: ${{ steps.versions.outputs.security }}
      core-version: ${{ steps.versions.outputs.core }}

    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: dnf install -y rpm-build rpmdevtools wget

      - name: Setup rpmbuild tree
        run: rpmdev-setuptree

      - name: Get versions from spec files
        id: versions
        run: |
          SECURITY_VERSION=$(grep '^Version:' flux-security/flux-security.spec | awk '{print $2}')
          CORE_VERSION=$(grep '^Version:' flux-core/flux-core.spec | awk '{print $2}')
          echo "security=$SECURITY_VERSION" >> $GITHUB_OUTPUT
          echo "core=$CORE_VERSION" >> $GITHUB_OUTPUT

      - name: Download sources
        run: |
          wget -O ~/rpmbuild/SOURCES/flux-security-${{ steps.versions.outputs.security }}.tar.gz \
            https://github.com/flux-framework/flux-security/releases/download/v${{ steps.versions.outputs.security }}/flux-security-${{ steps.versions.outputs.security }}.tar.gz
          wget -O ~/rpmbuild/SOURCES/flux-core-${{ steps.versions.outputs.core }}.tar.gz \
            https://github.com/flux-framework/flux-core/releases/download/v${{ steps.versions.outputs.core }}/flux-core-${{ steps.versions.outputs.core }}.tar.gz

      - name: Copy spec files and patches
        run: |
          cp flux-security/flux-security.spec ~/rpmbuild/SPECS/
          cp flux-core/flux-core.spec ~/rpmbuild/SPECS/
          cp flux-security/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-core/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true

      - name: Build SRPMs
        run: |
          rpmbuild -bs ~/rpmbuild/SPECS/flux-security.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-core.spec

      - name: Upload SRPMs
        uses: actions/upload-artifact@v4
        with:
          name: srpms
          path: ~/rpmbuild/SRPMS/*.src.rpm

  # ============================================================
  # STAGE 3: Mock builds for each target distribution
  # Runs in parallel across all supported distributions
  # ============================================================

  # Check if pre-built container is available
  check-container:
    name: Check container availability
    runs-on: ubuntu-latest
    outputs:
      image-available: ${{ steps.check.outputs.available }}
      image-to-use: ${{ steps.check.outputs.image }}
    steps:
      - name: Check if builder image exists
        id: check
        run: |
          if docker manifest inspect ${{ env.BUILDER_IMAGE }} > /dev/null 2>&1; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "image=${{ env.BUILDER_IMAGE }}" >> $GITHUB_OUTPUT
            echo "âœ… Pre-built container available: ${{ env.BUILDER_IMAGE }}"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "image=fedora:latest" >> $GITHUB_OUTPUT
            echo "âš ï¸ Pre-built container not found, falling back to fedora:latest"
          fi

  # Fedora 41 build
  mock-fedora-41:
    name: Mock build (fedora-41-x86_64)
    runs-on: ubuntu-latest
    needs: [build-srpm, check-container]
    container:
      image: ${{ needs.check-container.outputs.image-to-use }}
      options: --privileged
    steps:
      - uses: actions/checkout@v4

      - name: Install mock (if using fallback image)
        if: needs.check-container.outputs.image-available != 'true'
        run: |
          dnf install -y mock
          usermod -a -G mock root

      - name: Download SRPMs
        uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms

      - name: Initialize mock
        run: mock -r fedora-41-x86_64 --init

      - name: Build flux-security
        run: |
          set -o pipefail
          mock -r fedora-41-x86_64 --verbose --rebuild srpms/flux-security-*.src.rpm --resultdir=results-security 2>&1 | tee security-build.log

      - name: Install flux-security in mock
        run: |
          SECURITY_RPM=$(ls results-security/flux-security-[0-9]*.x86_64.rpm | head -1)
          SECURITY_DEVEL_RPM=$(ls results-security/flux-security-devel-*.x86_64.rpm | head -1)
          mock -r fedora-41-x86_64 --install "$SECURITY_RPM" "$SECURITY_DEVEL_RPM"

      - name: Build flux-core
        run: |
          set -o pipefail
          mock -r fedora-41-x86_64 --verbose --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results-core 2>&1 | tee core-build.log

      - name: Run package tests
        uses: ./.github/actions/test-packages
        with:
          mock-release: fedora-41-x86_64

      - name: Upload build results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-fedora-41-x86_64
          path: |
            results-security/
            results-core/
            security-build.log
            core-build.log

      - name: Cleanup mock
        if: always()
        run: mock -r fedora-41-x86_64 --clean

  # Fedora 42 build
  mock-fedora-42:
    name: Mock build (fedora-42-x86_64)
    runs-on: ubuntu-latest
    needs: [build-srpm, check-container]
    container:
      image: ${{ needs.check-container.outputs.image-to-use }}
      options: --privileged
    steps:
      - uses: actions/checkout@v4

      - name: Install mock (if using fallback image)
        if: needs.check-container.outputs.image-available != 'true'
        run: |
          dnf install -y mock
          usermod -a -G mock root

      - name: Download SRPMs
        uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms

      - name: Initialize mock
        run: mock -r fedora-42-x86_64 --init

      - name: Build flux-security
        run: |
          set -o pipefail
          mock -r fedora-42-x86_64 --verbose --rebuild srpms/flux-security-*.src.rpm --resultdir=results-security 2>&1 | tee security-build.log

      - name: Install flux-security in mock
        run: |
          SECURITY_RPM=$(ls results-security/flux-security-[0-9]*.x86_64.rpm | head -1)
          SECURITY_DEVEL_RPM=$(ls results-security/flux-security-devel-*.x86_64.rpm | head -1)
          mock -r fedora-42-x86_64 --install "$SECURITY_RPM" "$SECURITY_DEVEL_RPM"

      - name: Build flux-core
        run: |
          set -o pipefail
          mock -r fedora-42-x86_64 --verbose --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results-core 2>&1 | tee core-build.log

      - name: Run package tests
        uses: ./.github/actions/test-packages
        with:
          mock-release: fedora-42-x86_64

      - name: Upload build results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-fedora-42-x86_64
          path: |
            results-security/
            results-core/
            security-build.log
            core-build.log

      - name: Cleanup mock
        if: always()
        run: mock -r fedora-42-x86_64 --clean

  # CentOS Stream 9 + EPEL build
  mock-centos-9:
    name: Mock build (centos-stream+epel-9-x86_64)
    runs-on: ubuntu-latest
    needs: [build-srpm, check-container]
    container:
      image: ${{ needs.check-container.outputs.image-to-use }}
      options: --privileged
    steps:
      - uses: actions/checkout@v4

      - name: Install mock (if using fallback image)
        if: needs.check-container.outputs.image-available != 'true'
        run: |
          dnf install -y mock
          usermod -a -G mock root

      - name: Download SRPMs
        uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms

      - name: Initialize mock
        run: mock -r centos-stream+epel-9-x86_64 --init

      - name: Build flux-security
        run: |
          set -o pipefail
          mock -r centos-stream+epel-9-x86_64 --verbose --rebuild srpms/flux-security-*.src.rpm --resultdir=results-security 2>&1 | tee security-build.log

      - name: Install flux-security in mock
        run: |
          SECURITY_RPM=$(ls results-security/flux-security-[0-9]*.x86_64.rpm | head -1)
          SECURITY_DEVEL_RPM=$(ls results-security/flux-security-devel-*.x86_64.rpm | head -1)
          mock -r centos-stream+epel-9-x86_64 --install "$SECURITY_RPM" "$SECURITY_DEVEL_RPM"

      - name: Build flux-core
        run: |
          set -o pipefail
          mock -r centos-stream+epel-9-x86_64 --verbose --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results-core 2>&1 | tee core-build.log

      - name: Run package tests
        uses: ./.github/actions/test-packages
        with:
          mock-release: centos-stream+epel-9-x86_64

      - name: Upload build results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-centos-stream+epel-9-x86_64
          path: |
            results-security/
            results-core/
            security-build.log
            core-build.log

      - name: Cleanup mock
        if: always()
        run: mock -r centos-stream+epel-9-x86_64 --clean

  # CentOS Stream 10 + EPEL build
  mock-centos-10:
    name: Mock build (centos-stream+epel-10-x86_64)
    runs-on: ubuntu-latest
    needs: [build-srpm, check-container]
    container:
      image: ${{ needs.check-container.outputs.image-to-use }}
      options: --privileged
    steps:
      - uses: actions/checkout@v4

      - name: Install mock (if using fallback image)
        if: needs.check-container.outputs.image-available != 'true'
        run: |
          dnf install -y mock
          usermod -a -G mock root

      - name: Download SRPMs
        uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms

      - name: Initialize mock
        run: mock -r centos-stream+epel-10-x86_64 --init

      - name: Build flux-security
        run: |
          set -o pipefail
          mock -r centos-stream+epel-10-x86_64 --verbose --rebuild srpms/flux-security-*.src.rpm --resultdir=results-security 2>&1 | tee security-build.log

      - name: Install flux-security in mock
        run: |
          SECURITY_RPM=$(ls results-security/flux-security-[0-9]*.x86_64.rpm | head -1)
          SECURITY_DEVEL_RPM=$(ls results-security/flux-security-devel-*.x86_64.rpm | head -1)
          mock -r centos-stream+epel-10-x86_64 --install "$SECURITY_RPM" "$SECURITY_DEVEL_RPM"

      - name: Build flux-core
        run: |
          set -o pipefail
          mock -r centos-stream+epel-10-x86_64 --verbose --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results-core 2>&1 | tee core-build.log

      - name: Run package tests
        uses: ./.github/actions/test-packages
        with:
          mock-release: centos-stream+epel-10-x86_64

      - name: Upload build results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-centos-stream+epel-10-x86_64
          path: |
            results-security/
            results-core/
            security-build.log
            core-build.log

      - name: Cleanup mock
        if: always()
        run: mock -r centos-stream+epel-10-x86_64 --clean

  # ============================================================
  # STAGE 4: Summary job - waits for all builds to complete
  # ============================================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs:
      - mock-fedora-41
      - mock-fedora-42
      - mock-centos-9
      - mock-centos-10
    if: always()
    steps:
      - name: Check build results
        run: |
          echo "## Build Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check each job result
          declare -A results
          results["Fedora 41"]="${{ needs.mock-fedora-41.result }}"
          results["Fedora 42"]="${{ needs.mock-fedora-42.result }}"
          results["CentOS Stream 9"]="${{ needs.mock-centos-9.result }}"
          results["CentOS Stream 10"]="${{ needs.mock-centos-10.result }}"

          echo "| Distribution | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------------|--------|" >> $GITHUB_STEP_SUMMARY

          all_passed=true
          for dist in "${!results[@]}"; do
            status="${results[$dist]}"
            if [ "$status" = "success" ]; then
              echo "| $dist | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
            elif [ "$status" = "skipped" ]; then
              echo "| $dist | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| $dist | âŒ Failed |" >> $GITHUB_STEP_SUMMARY
              all_passed=false
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$all_passed" = "true" ]; then
            echo "### ðŸŽ‰ All builds completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ Some builds failed. Check the individual job logs for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
