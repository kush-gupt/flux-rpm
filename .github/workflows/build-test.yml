name: Build and Test RPMs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel in-progress runs when a new run is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILDER_IMAGE: ghcr.io/${{ github.repository }}/flux-rpm-builder:latest

jobs:
  # ============================================================
  # Quick validation jobs (run in parallel, fail fast)
  # ============================================================
  spelling:
    name: Spelling check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check Spelling
        uses: crate-ci/typos@v1.28.4
        with:
          config: .github/typos.toml

  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run shellcheck on scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.github'
          ignore_paths: ''
          severity: warning

  lint:
    name: Lint spec files
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install rpmlint with config files
        run: |
          dnf install -y rpmlint
          
          # Copy rpmlintrc files to expected location
          mkdir -p ~/.config/rpmlint
          for pkg in flux-security flux-core flux-sched flux-accounting; do
            if [ -f "$pkg/$pkg.rpmlintrc" ]; then
              cp "$pkg/$pkg.rpmlintrc" ~/.config/rpmlint/
            fi
          done
      
      - name: Run rpmlint on all spec files
        run: |
          # Note: rpmlintrc filters are only applied when checking built RPMs,
          # not spec files. We allow warnings here and do strict checking on
          # built packages in the build job.
          echo "=== Linting flux-security.spec ===" 
          rpmlint flux-security/flux-security.spec || true
          
          echo "=== Linting flux-core.spec ===" 
          rpmlint flux-core/flux-core.spec || true
          
          echo "=== Linting flux-sched.spec ===" 
          rpmlint flux-sched/flux-sched.spec || true
          
          echo "=== Linting flux-accounting.spec ===" 
          rpmlint flux-accounting/flux-accounting.spec || true
          
          echo "=== All spec files linted (warnings allowed) ==="

  spec-validation:
    name: Validate spec files
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install rpmspec
        run: dnf install -y rpm-build
      
      - name: Validate spec file syntax
        run: |
          for spec in flux-*/flux-*.spec; do
            echo "Validating: $spec"
            rpmspec -P "$spec" > /dev/null
            echo "  ✓ $spec is valid"
          done
      
      - name: Check required spec fields
        run: |
          for spec in flux-*/flux-*.spec; do
            echo "Checking required fields in: $spec"
            
            # Check for required fields
            grep -q "^Name:" "$spec" || { echo "Missing Name in $spec"; exit 1; }
            grep -q "^Version:" "$spec" || { echo "Missing Version in $spec"; exit 1; }
            grep -q "^Release:" "$spec" || { echo "Missing Release in $spec"; exit 1; }
            grep -q "^License:" "$spec" || { echo "Missing License in $spec"; exit 1; }
            grep -q "^URL:" "$spec" || { echo "Missing URL in $spec"; exit 1; }
            grep -q "^Source0:" "$spec" || { echo "Missing Source0 in $spec"; exit 1; }
            grep -q "^%description" "$spec" || { echo "Missing %description in $spec"; exit 1; }
            grep -q "^%changelog" "$spec" || { echo "Missing %changelog in $spec"; exit 1; }
            
            # Check for Fedora best practices
            grep -q "%{?dist}" "$spec" || echo "  Warning: %{?dist} not found in Release"
            grep -q "%autosetup" "$spec" || grep -q "%setup" "$spec" || echo "  Warning: No %setup or %autosetup found"
            
            echo "  ✓ $spec has all required fields"
          done
      
      - name: Check changelog format
        run: |
          for spec in flux-*/flux-*.spec; do
            echo "Checking changelog in: $spec"
            # Extract changelog and verify format
            sed -n '/%changelog/,$ p' "$spec" | head -5
          done

  # Check container availability (fast, parallel)
  check-container:
    name: Check container
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.check.outputs.image }}
    steps:
      - id: check
        run: |
          if docker manifest inspect ${{ env.BUILDER_IMAGE }} > /dev/null 2>&1; then
            echo "image=${{ env.BUILDER_IMAGE }}" >> $GITHUB_OUTPUT
          else
            echo "image=fedora:latest" >> $GITHUB_OUTPUT
          fi

  # Build SRPMs (no lint dependency for faster startup)
  build-srpms:
    name: Build SRPMs
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Build all SRPMs
        run: |
          dnf install -y rpm-build rpmdevtools wget
          rpmdev-setuptree
          
          # Get versions
          SEC_VER=$(grep '^Version:' flux-security/flux-security.spec | awk '{print $2}')
          CORE_VER=$(grep '^Version:' flux-core/flux-core.spec | awk '{print $2}')
          SCHED_VER=$(grep '^Version:' flux-sched/flux-sched.spec | awk '{print $2}')
          ACCT_VER=$(grep '^Version:' flux-accounting/flux-accounting.spec | awk '{print $2}')
          
          # Download sources in parallel
          wget -q -O ~/rpmbuild/SOURCES/flux-security-${SEC_VER}.tar.gz \
            https://github.com/flux-framework/flux-security/releases/download/v${SEC_VER}/flux-security-${SEC_VER}.tar.gz &
          wget -q -O ~/rpmbuild/SOURCES/flux-core-${CORE_VER}.tar.gz \
            https://github.com/flux-framework/flux-core/releases/download/v${CORE_VER}/flux-core-${CORE_VER}.tar.gz &
          wget -q -O ~/rpmbuild/SOURCES/flux-sched-${SCHED_VER}.tar.gz \
            https://github.com/flux-framework/flux-sched/releases/download/v${SCHED_VER}/flux-sched-${SCHED_VER}.tar.gz &
          wget -q -O ~/rpmbuild/SOURCES/flux-accounting-${ACCT_VER}.tar.gz \
            https://github.com/flux-framework/flux-accounting/releases/download/v${ACCT_VER}/flux-accounting-${ACCT_VER}.tar.gz &
          wait
          
          # Copy specs and patches
          cp flux-security/flux-security.spec ~/rpmbuild/SPECS/
          cp flux-core/flux-core.spec ~/rpmbuild/SPECS/
          cp flux-sched/flux-sched.spec ~/rpmbuild/SPECS/
          cp flux-accounting/flux-accounting.spec ~/rpmbuild/SPECS/
          cp flux-security/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-core/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-sched/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-accounting/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          
          # Build SRPMs
          rpmbuild -bs ~/rpmbuild/SPECS/flux-security.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-core.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-sched.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-accounting.spec
          
          # Move to workspace for upload
          mkdir -p srpms
          mv ~/rpmbuild/SRPMS/*.src.rpm srpms/
      - uses: actions/upload-artifact@v4
        with:
          name: srpms
          path: srpms/

  # Build all packages for each distro in a single job
  # This eliminates job startup overhead and artifact transfer between packages
  build-all:
    name: Build (${{ matrix.distro }})
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container]
    # Don't let rawhide failures fail the entire workflow
    continue-on-error: ${{ matrix.allow-failure || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora-41
            mock-release: fedora-41-x86_64
            short-name: f41
          - distro: fedora-42
            mock-release: fedora-42-x86_64
            short-name: f42
          - distro: fedora-43
            mock-release: fedora-43-x86_64
            short-name: f43
          - distro: fedora-rawhide
            mock-release: fedora-rawhide-x86_64
            short-name: rawhide
            allow-failure: true
          - distro: centos-9
            mock-release: centos-stream+epel-9-x86_64
            short-name: el9
          - distro: centos-10
            mock-release: centos-stream+epel-10-x86_64
            short-name: el10
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Download SRPMs
        uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms

      - name: Restore mock cache
        uses: actions/cache@v4
        with:
          path: /var/cache/mock
          key: mock-${{ matrix.mock-release }}-${{ hashFiles('flux-*/*.spec') }}
          restore-keys: |
            mock-${{ matrix.mock-release }}-

      - name: List SRPMs
        run: ls -la ./srpms/

      - name: Initialize mock
        run: mock -r ${{ matrix.mock-release }} --init

      # ============================================================
      # Build flux-security
      # ============================================================
      - name: Build flux-security
        run: |
          set -o pipefail
          mock -r ${{ matrix.mock-release }} --no-clean --no-cleanup-after --rebuild srpms/flux-security-*.src.rpm --resultdir=results-security 2>&1 | tee security-build.log

      - name: Install flux-security in mock
        run: |
          SECURITY_RPM=$(ls results-security/flux-security-[0-9]*.x86_64.rpm | head -1)
          SECURITY_DEVEL_RPM=$(ls results-security/flux-security-devel-*.x86_64.rpm | head -1)
          echo "Installing: $SECURITY_RPM $SECURITY_DEVEL_RPM"
          # Use --no-clean and --no-cleanup-after to preserve chroot state
          mock -r ${{ matrix.mock-release }} --no-clean --no-cleanup-after --install "$SECURITY_RPM" "$SECURITY_DEVEL_RPM"

      # ============================================================
      # Build flux-core
      # ============================================================
      - name: Build flux-core
        run: |
          set -o pipefail
          mock -r ${{ matrix.mock-release }} --no-clean --no-cleanup-after --rebuild srpms/flux-core-*.src.rpm --resultdir=results-core 2>&1 | tee core-build.log

      - name: Install flux-core in mock
        run: |
          CORE_RPM=$(ls results-core/flux-core-[0-9]*.x86_64.rpm | head -1)
          CORE_DEVEL_RPM=$(ls results-core/flux-core-devel-*.x86_64.rpm | head -1)
          PYTHON_RPM=$(ls results-core/python3-flux-[0-9]*.x86_64.rpm | head -1)
          echo "Installing: $CORE_RPM $CORE_DEVEL_RPM $PYTHON_RPM"
          # Use --no-clean and --no-cleanup-after to preserve chroot state
          mock -r ${{ matrix.mock-release }} --no-clean --no-cleanup-after --install "$CORE_RPM" "$CORE_DEVEL_RPM" "$PYTHON_RPM"

      # ============================================================
      # Build flux-sched and flux-accounting (both depend on core)
      # ============================================================
      - name: Build flux-sched
        run: |
          set -o pipefail
          mock -r ${{ matrix.mock-release }} --no-clean --no-cleanup-after --rebuild srpms/flux-sched-*.src.rpm --resultdir=results-sched 2>&1 | tee sched-build.log

      - name: Build flux-accounting
        run: |
          set -o pipefail
          mock -r ${{ matrix.mock-release }} --no-clean --rebuild srpms/flux-accounting-*.src.rpm --resultdir=results-accounting 2>&1 | tee accounting-build.log

      # ============================================================
      # Generate summary and upload artifacts
      # ============================================================
      - name: Generate build summary
        if: always()
        run: |
          echo "=== Build Summary for ${{ matrix.mock-release }} ===" | tee build-summary.txt
          echo "Build completed: $(date)" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "=== flux-security packages ===" >> build-summary.txt
          ls -la results-security/*.rpm 2>/dev/null | grep -v debuginfo >> build-summary.txt || echo "No packages" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "=== flux-core packages ===" >> build-summary.txt
          ls -la results-core/*.rpm 2>/dev/null | grep -v debuginfo >> build-summary.txt || echo "No packages" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "=== flux-sched packages ===" >> build-summary.txt
          ls -la results-sched/*.rpm 2>/dev/null | grep -v debuginfo >> build-summary.txt || echo "No packages" >> build-summary.txt
          echo "" >> build-summary.txt
          echo "=== flux-accounting packages ===" >> build-summary.txt
          ls -la results-accounting/*.rpm 2>/dev/null | grep -v debuginfo >> build-summary.txt || echo "No packages" >> build-summary.txt

      - name: Upload all build results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-${{ matrix.short-name }}
          path: |
            results-security/
            results-core/
            results-sched/
            results-accounting/
            *-build.log
            build-summary.txt

      - name: Cleanup mock
        if: always()
        run: mock -r ${{ matrix.mock-release }} --clean

  # ============================================================
  # Integration Tests - Run upstream test suites against installed RPMs
  # Uses FLUX_TEST_INSTALLED_PATH to test installed packages
  # ============================================================
  integration-tests:
    name: Integration Tests (${{ matrix.distro }})
    runs-on: ubuntu-latest
    needs: [build-all]
    timeout-minutes: 60
    # Don't let rawhide failures fail the entire workflow
    continue-on-error: ${{ matrix.allow-failure || false }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Fedora releases
          - distro: fedora-41
            image: fedora:41
            short-name: f41
            pkg-manager: dnf
          - distro: fedora-42
            image: fedora:42
            short-name: f42
            pkg-manager: dnf
          - distro: fedora-43
            image: fedora:43
            short-name: f43
            pkg-manager: dnf
          - distro: fedora-rawhide
            image: fedora:rawhide
            short-name: rawhide
            pkg-manager: dnf
            allow-failure: true
          # CentOS/RHEL releases
          - distro: centos-9
            image: quay.io/centos/centos:stream9
            short-name: el9
            pkg-manager: dnf
          - distro: centos-10
            image: quay.io/centos/centos:stream10
            short-name: el10
            pkg-manager: dnf
    container:
      image: ${{ matrix.image }}
      options: --privileged --cap-add=SYS_PTRACE
    env:
      # Tell test suite to use installed flux, not build directory
      FLUX_TEST_INSTALLED_PATH: /usr/bin
      TAP_DRIVER_QUIET: 1
      FLUX_TEST_TIMEOUT: 300

    steps:
      - uses: actions/checkout@v4

      - name: Download RPMs
        uses: actions/download-artifact@v4
        with:
          name: rpms-${{ matrix.short-name }}
          path: ./rpms

      - name: Enable EPEL (CentOS/RHEL only)
        if: startsWith(matrix.distro, 'centos')
        run: |
          ${{ matrix.pkg-manager }} install -y epel-release
          ${{ matrix.pkg-manager }} config-manager --set-enabled crb || true

      - name: Install build/test dependencies
        run: |
          # Essential build tools - must succeed
          # Use --allowerasing to handle curl-minimal conflict on CentOS
          ${{ matrix.pkg-manager }} install -y --allowerasing \
            make autoconf automake libtool gcc gcc-c++ \
            python3-devel python3-setuptools \
            curl tar gzip jq procps-ng hostname which diffutils findutils \
            perl-Test-Harness
          
          # Additional dependencies - some may not exist on all distros
          ${{ matrix.pkg-manager }} install -y --allowerasing \
            cmake pkgconfig \
            python3-cffi python3-pyyaml python3-jsonschema python3-sphinx \
            libuuid-devel jansson-devel lz4-devel libarchive-devel \
            hwloc-devel sqlite-devel ncurses-devel libsodium-devel zeromq-devel \
            lua lua-devel lua-posix \
            boost-devel boost-graph boost-filesystem boost-system \
            libedit-devel readline-devel yaml-cpp-devel || true

      - name: Install Flux RPMs
        run: |
          # Install all non-debug RPMs including devel packages for test builds
          ${{ matrix.pkg-manager }} install -y \
            rpms/results-security/flux-security-[0-9]*.x86_64.rpm \
            rpms/results-security/flux-security-devel-*.x86_64.rpm \
            rpms/results-core/flux-core-[0-9]*.x86_64.rpm \
            rpms/results-core/flux-core-devel-*.x86_64.rpm \
            rpms/results-core/python3-flux-[0-9]*.x86_64.rpm \
            rpms/results-sched/flux-sched-[0-9]*.x86_64.rpm \
            rpms/results-accounting/flux-accounting-[0-9]*.x86_64.rpm
          
          echo "=== Installed Flux packages ===" 
          rpm -qa | grep -E '^(flux|python3-flux)' | sort
          
          # Verify flux works
          flux --version

      # ============================================================
      # flux-core upstream tests
      # ============================================================
      - name: Download flux-core source for tests
        run: |
          CORE_VER=$(rpm -q --qf '%{VERSION}' flux-core)
          echo "Testing flux-core version: $CORE_VER"
          curl -sL "https://github.com/flux-framework/flux-core/releases/download/v${CORE_VER}/flux-core-${CORE_VER}.tar.gz" \
            -o flux-core.tar.gz
          tar xzf flux-core.tar.gz
          mv flux-core-${CORE_VER} flux-core-src

      - name: Configure flux-core tests
        working-directory: flux-core-src
        run: |
          # Configure to build test infrastructure against installed flux
          # Note: Do NOT use --disable-docs as we need doc/man3/example/ programs
          ./configure --prefix=/usr \
            --with-flux-security \
            CFLAGS="-O2 -Wno-error" \
            PKG_CONFIG_PATH=/usr/lib64/pkgconfig
          
          # Full build to create all test binaries and example programs
          make -j$(nproc)

      - name: Run flux-core tests
        working-directory: flux-core-src/t
        run: |
          # Set up paths for test infrastructure
          # The built flux commands (like flux-modprobe) must be in PATH
          export PATH=$GITHUB_WORKSPACE/flux-core-src/src/cmd:$PATH
          
          # Tell flux where to find additional subcommands from build tree
          export FLUX_EXEC_PATH=$GITHUB_WORKSPACE/flux-core-src/src/cmd
          
          # Python path for flux module built in tree
          export PYTHONPATH=$GITHUB_WORKSPACE/flux-core-src/src/bindings/python:$PYTHONPATH
          
          # Core test environment variables
          export FLUX_TEST_INSTALLED_PATH=/usr/bin
          export FLUX_BUILD_DIR=$GITHUB_WORKSPACE/flux-core-src
          export SHARNESS_BUILD_DIRECTORY=$GITHUB_WORKSPACE/flux-core-src
          
          # Run a selection of important tests (not the full suite for CI time)
          prove -v --timer -j4 \
            ./t0001-basic.t \
            ./t0002-request.t \
            ./t0003-module.t \
            ./t0004-event.t \
            ./t0007-ping.t \
            ./t0008-attr.t \
            ./t0009-dmesg.t \
            ./t1000-kvs.t \
            ./t1001-kvs-internals.t
        continue-on-error: ${{ matrix.allow-failure || false }}

      # ============================================================
      # flux-sched upstream tests
      # ============================================================
      - name: Download flux-sched source for tests
        run: |
          SCHED_VER=$(rpm -q --qf '%{VERSION}' flux-sched)
          echo "Testing flux-sched version: $SCHED_VER"
          curl -sL "https://github.com/flux-framework/flux-sched/releases/download/v${SCHED_VER}/flux-sched-${SCHED_VER}.tar.gz" \
            -o flux-sched.tar.gz
          tar xzf flux-sched.tar.gz
          mv flux-sched-${SCHED_VER} flux-sched-src

      - name: Configure and build flux-sched tests
        working-directory: flux-sched-src
        run: |
          mkdir -p build && cd build
          cmake .. \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCMAKE_BUILD_TYPE=Release \
            -DFLUX_PREFIX=/usr
          
          # Build test infrastructure
          make -j$(nproc)

      - name: Run flux-sched tests
        working-directory: flux-sched-src/t
        run: |
          # Set up paths for test infrastructure (need flux-core build tree for flux-modprobe)
          export PATH=$GITHUB_WORKSPACE/flux-core-src/src/cmd:$PATH
          export FLUX_EXEC_PATH=$GITHUB_WORKSPACE/flux-core-src/src/cmd
          export PYTHONPATH=$GITHUB_WORKSPACE/flux-core-src/src/bindings/python:$PYTHONPATH
          
          # Core test environment variables
          export FLUX_TEST_INSTALLED_PATH=/usr/bin
          export FLUX_BUILD_DIR=$GITHUB_WORKSPACE/flux-sched-src/build
          export SHARNESS_BUILD_DIRECTORY=$GITHUB_WORKSPACE/flux-sched-src/build
          
          # Run scheduler-specific tests
          prove -v --timer -j2 \
            ./t1001-qmanager-basic.t \
            ./t1003-qmanager-policy.t \
            ./t1010-sync-modules.t
        continue-on-error: ${{ matrix.allow-failure || false }}

      # ============================================================
      # flux-accounting upstream tests
      # ============================================================
      - name: Download flux-accounting source for tests
        run: |
          ACCT_VER=$(rpm -q --qf '%{VERSION}' flux-accounting)
          echo "Testing flux-accounting version: $ACCT_VER"
          curl -sL "https://github.com/flux-framework/flux-accounting/releases/download/v${ACCT_VER}/flux-accounting-${ACCT_VER}.tar.gz" \
            -o flux-accounting.tar.gz
          tar xzf flux-accounting.tar.gz
          mv flux-accounting-${ACCT_VER} flux-accounting-src

      - name: Configure flux-accounting tests
        working-directory: flux-accounting-src
        run: |
          ./configure --prefix=/usr \
            PKG_CONFIG_PATH=/usr/lib64/pkgconfig
          make -j$(nproc)

      - name: Run flux-accounting tests
        working-directory: flux-accounting-src/t
        run: |
          # Set up paths for test infrastructure (need flux-core build tree for flux-modprobe)
          export PATH=$GITHUB_WORKSPACE/flux-core-src/src/cmd:$PATH
          export FLUX_EXEC_PATH=$GITHUB_WORKSPACE/flux-core-src/src/cmd
          export PYTHONPATH=$GITHUB_WORKSPACE/flux-core-src/src/bindings/python:$PYTHONPATH
          
          # Core test environment variables
          export FLUX_TEST_INSTALLED_PATH=/usr/bin
          export FLUX_BUILD_DIR=$GITHUB_WORKSPACE/flux-accounting-src
          export SHARNESS_BUILD_DIRECTORY=$GITHUB_WORKSPACE/flux-accounting-src
          
          # Run accounting-specific tests
          prove -v --timer -j2 \
            ./t1001-mf-priority-basic.t \
            ./t1007-flux-account-users.t \
            ./t1008-mf-priority-update.t
        continue-on-error: ${{ matrix.allow-failure || false }}

      # ============================================================
      # Summary
      # ============================================================
      - name: Generate test summary
        if: always()
        run: |
          echo "=== Integration Test Summary ===" | tee test-summary.txt
          echo "Distro: ${{ matrix.distro }}" >> test-summary.txt
          echo "Date: $(date)" >> test-summary.txt
          echo "" >> test-summary.txt
          echo "Installed packages:" >> test-summary.txt
          rpm -qa | grep -E '^(flux|python3-flux)' | sort >> test-summary.txt
          echo "" >> test-summary.txt
          echo "Test environment:" >> test-summary.txt
          echo "  FLUX_TEST_INSTALLED_PATH=$FLUX_TEST_INSTALLED_PATH" >> test-summary.txt

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.short-name }}
          path: |
            test-summary.txt
            flux-core-src/t/test-results/
            flux-sched-src/t/test-results/
            flux-accounting-src/t/test-results/
