name: Build and Test RPMs

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  BUILDER_IMAGE: ghcr.io/${{ github.repository }}/flux-rpm-builder:latest

jobs:
  lint:
    name: Lint spec files
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Install and run rpmlint
        run: |
          dnf install -y rpmlint
          rpmlint flux-security/flux-security.spec || true
          rpmlint flux-core/flux-core.spec || true
          rpmlint flux-sched/flux-sched.spec || true

  # Check container availability (fast, parallel)
  check-container:
    name: Check container
    runs-on: ubuntu-latest
    outputs:
      image: ${{ steps.check.outputs.image }}
    steps:
      - id: check
        run: |
          if docker manifest inspect ${{ env.BUILDER_IMAGE }} > /dev/null 2>&1; then
            echo "image=${{ env.BUILDER_IMAGE }}" >> $GITHUB_OUTPUT
          else
            echo "image=fedora:latest" >> $GITHUB_OUTPUT
          fi

  # Build SRPMs in parallel (no lint dependency)
  build-srpms:
    name: Build SRPMs
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4
      - name: Build all SRPMs
        run: |
          dnf install -y rpm-build rpmdevtools wget
          rpmdev-setuptree
          
          # Get versions
          SEC_VER=$(grep '^Version:' flux-security/flux-security.spec | awk '{print $2}')
          CORE_VER=$(grep '^Version:' flux-core/flux-core.spec | awk '{print $2}')
          SCHED_VER=$(grep '^Version:' flux-sched/flux-sched.spec | awk '{print $2}')
          
          # Download sources in parallel
          wget -q -O ~/rpmbuild/SOURCES/flux-security-${SEC_VER}.tar.gz \
            https://github.com/flux-framework/flux-security/releases/download/v${SEC_VER}/flux-security-${SEC_VER}.tar.gz &
          wget -q -O ~/rpmbuild/SOURCES/flux-core-${CORE_VER}.tar.gz \
            https://github.com/flux-framework/flux-core/releases/download/v${CORE_VER}/flux-core-${CORE_VER}.tar.gz &
          wget -q -O ~/rpmbuild/SOURCES/flux-sched-${SCHED_VER}.tar.gz \
            https://github.com/flux-framework/flux-sched/releases/download/v${SCHED_VER}/flux-sched-${SCHED_VER}.tar.gz &
          wait
          
          # Copy specs and patches
          cp flux-security/flux-security.spec ~/rpmbuild/SPECS/
          cp flux-core/flux-core.spec ~/rpmbuild/SPECS/
          cp flux-sched/flux-sched.spec ~/rpmbuild/SPECS/
          cp flux-security/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-core/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          cp flux-sched/*.patch ~/rpmbuild/SOURCES/ 2>/dev/null || true
          
          # Build SRPMs
          rpmbuild -bs ~/rpmbuild/SPECS/flux-security.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-core.spec
          rpmbuild -bs ~/rpmbuild/SPECS/flux-sched.spec
          
          # Move to workspace for upload
          mkdir -p srpms
          mv ~/rpmbuild/SRPMS/*.src.rpm srpms/
      - uses: actions/upload-artifact@v4
        with:
          name: srpms
          path: srpms/

  # flux-security builds (all distros parallel)
  mock-security-fedora-41:
    name: security (f41)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - name: Build
        run: |
          mock -r fedora-41-x86_64 --rebuild srpms/flux-security-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        with:
          name: rpms-security-f41
          path: results/
      - if: always()
        run: mock -r fedora-41-x86_64 --clean

  mock-security-fedora-42:
    name: security (f42)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - name: Build
        run: |
          mock -r fedora-42-x86_64 --rebuild srpms/flux-security-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        with:
          name: rpms-security-f42
          path: results/
      - if: always()
        run: mock -r fedora-42-x86_64 --clean

  mock-security-centos-9:
    name: security (el9)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - name: Build
        run: |
          mock -r centos-stream+epel-9-x86_64 --rebuild srpms/flux-security-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        with:
          name: rpms-security-el9
          path: results/
      - if: always()
        run: mock -r centos-stream+epel-9-x86_64 --clean

  mock-security-centos-10:
    name: security (el10)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - name: Build
        run: |
          mock -r centos-stream+epel-10-x86_64 --rebuild srpms/flux-security-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        with:
          name: rpms-security-el10
          path: results/
      - if: always()
        run: mock -r centos-stream+epel-10-x86_64 --clean

  # flux-core builds (wait for matching security, then parallel)
  mock-core-fedora-41:
    name: core (f41)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container, mock-security-fedora-41]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - uses: actions/download-artifact@v4
        with:
          name: rpms-security-f41
          path: ./security
      - name: Build
        run: |
          mock -r fedora-41-x86_64 --init
          mock -r fedora-41-x86_64 --install security/flux-security-[0-9]*.x86_64.rpm security/flux-security-devel-*.x86_64.rpm
          mock -r fedora-41-x86_64 --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        with:
          name: rpms-core-f41
          path: results/
      - if: always()
        run: mock -r fedora-41-x86_64 --clean

  mock-core-fedora-42:
    name: core (f42)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container, mock-security-fedora-42]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - uses: actions/download-artifact@v4
        with:
          name: rpms-security-f42
          path: ./security
      - name: Build
        run: |
          mock -r fedora-42-x86_64 --init
          mock -r fedora-42-x86_64 --install security/flux-security-[0-9]*.x86_64.rpm security/flux-security-devel-*.x86_64.rpm
          mock -r fedora-42-x86_64 --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        with:
          name: rpms-core-f42
          path: results/
      - if: always()
        run: mock -r fedora-42-x86_64 --clean

  mock-core-centos-9:
    name: core (el9)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container, mock-security-centos-9]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - uses: actions/download-artifact@v4
        with:
          name: rpms-security-el9
          path: ./security
      - name: Build
        run: |
          mock -r centos-stream+epel-9-x86_64 --init
          mock -r centos-stream+epel-9-x86_64 --install security/flux-security-[0-9]*.x86_64.rpm security/flux-security-devel-*.x86_64.rpm
          mock -r centos-stream+epel-9-x86_64 --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        with:
          name: rpms-core-el9
          path: results/
      - if: always()
        run: mock -r centos-stream+epel-9-x86_64 --clean

  mock-core-centos-10:
    name: core (el10)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container, mock-security-centos-10]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - uses: actions/download-artifact@v4
        with:
          name: rpms-security-el10
          path: ./security
      - name: Build
        run: |
          mock -r centos-stream+epel-10-x86_64 --init
          mock -r centos-stream+epel-10-x86_64 --install security/flux-security-[0-9]*.x86_64.rpm security/flux-security-devel-*.x86_64.rpm
          mock -r centos-stream+epel-10-x86_64 --no-clean --rebuild srpms/flux-core-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        with:
          name: rpms-core-el10
          path: results/
      - if: always()
        run: mock -r centos-stream+epel-10-x86_64 --clean

  # flux-sched builds (wait for matching core, then parallel)
  mock-sched-fedora-41:
    name: sched (f41)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container, mock-core-fedora-41]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - uses: actions/download-artifact@v4
        with:
          name: rpms-security-f41
          path: ./security
      - uses: actions/download-artifact@v4
        with:
          name: rpms-core-f41
          path: ./core
      - name: Build
        run: |
          mock -r fedora-41-x86_64 --init
          mock -r fedora-41-x86_64 --install security/flux-security-[0-9]*.x86_64.rpm security/flux-security-devel-*.x86_64.rpm
          mock -r fedora-41-x86_64 --install core/flux-core-[0-9]*.x86_64.rpm core/flux-core-devel-*.x86_64.rpm core/python3-flux-[0-9]*.x86_64.rpm
          mock -r fedora-41-x86_64 --no-clean --rebuild srpms/flux-sched-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-sched-f41
          path: results/
      - if: always()
        run: mock -r fedora-41-x86_64 --clean

  mock-sched-fedora-42:
    name: sched (f42)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container, mock-core-fedora-42]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - uses: actions/download-artifact@v4
        with:
          name: rpms-security-f42
          path: ./security
      - uses: actions/download-artifact@v4
        with:
          name: rpms-core-f42
          path: ./core
      - name: Build
        run: |
          mock -r fedora-42-x86_64 --init
          mock -r fedora-42-x86_64 --install security/flux-security-[0-9]*.x86_64.rpm security/flux-security-devel-*.x86_64.rpm
          mock -r fedora-42-x86_64 --install core/flux-core-[0-9]*.x86_64.rpm core/flux-core-devel-*.x86_64.rpm core/python3-flux-[0-9]*.x86_64.rpm
          mock -r fedora-42-x86_64 --no-clean --rebuild srpms/flux-sched-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-sched-f42
          path: results/
      - if: always()
        run: mock -r fedora-42-x86_64 --clean

  mock-sched-centos-9:
    name: sched (el9)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container, mock-core-centos-9]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - uses: actions/download-artifact@v4
        with:
          name: rpms-security-el9
          path: ./security
      - uses: actions/download-artifact@v4
        with:
          name: rpms-core-el9
          path: ./core
      - name: Build
        run: |
          mock -r centos-stream+epel-9-x86_64 --init
          mock -r centos-stream+epel-9-x86_64 --install security/flux-security-[0-9]*.x86_64.rpm security/flux-security-devel-*.x86_64.rpm
          mock -r centos-stream+epel-9-x86_64 --install core/flux-core-[0-9]*.x86_64.rpm core/flux-core-devel-*.x86_64.rpm core/python3-flux-[0-9]*.x86_64.rpm
          mock -r centos-stream+epel-9-x86_64 --no-clean --rebuild srpms/flux-sched-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-sched-el9
          path: results/
      - if: always()
        run: mock -r centos-stream+epel-9-x86_64 --clean

  mock-sched-centos-10:
    name: sched (el10)
    runs-on: ubuntu-latest
    needs: [build-srpms, check-container, mock-core-centos-10]
    container:
      image: ${{ needs.check-container.outputs.image }}
      options: --privileged
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: srpms
          path: ./srpms
      - uses: actions/download-artifact@v4
        with:
          name: rpms-security-el10
          path: ./security
      - uses: actions/download-artifact@v4
        with:
          name: rpms-core-el10
          path: ./core
      - name: Build
        run: |
          mock -r centos-stream+epel-10-x86_64 --init
          mock -r centos-stream+epel-10-x86_64 --install security/flux-security-[0-9]*.x86_64.rpm security/flux-security-devel-*.x86_64.rpm
          mock -r centos-stream+epel-10-x86_64 --install core/flux-core-[0-9]*.x86_64.rpm core/flux-core-devel-*.x86_64.rpm core/python3-flux-[0-9]*.x86_64.rpm
          mock -r centos-stream+epel-10-x86_64 --no-clean --rebuild srpms/flux-sched-*.src.rpm --resultdir=results
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpms-sched-el10
          path: results/
      - if: always()
        run: mock -r centos-stream+epel-10-x86_64 --clean
