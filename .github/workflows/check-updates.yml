name: Check for Updates

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

env:
  # Use pre-built container for faster builds
  BUILDER_IMAGE: ghcr.io/${{ github.repository }}/flux-rpm-builder:latest

jobs:
  # ============================================================
  # Check for version updates (runs in parallel)
  # ============================================================
  check-flux-security:
    name: Check flux-security updates
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          version=$(grep '^Version:' flux-security/flux-security.spec | awk '{print $2}')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Get latest release
        id: latest
        run: |
          response=$(curl -sf "https://api.github.com/repos/flux-framework/flux-security/releases?per_page=1") || {
            echo "Failed to fetch releases from GitHub API"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          }
          version=$(echo "$response" | jq -r '.[0].tag_name // empty' | sed 's/^v//')
          if [ -z "$version" ]; then
            echo "Could not parse version from GitHub API response"
            echo "version=" >> $GITHUB_OUTPUT
          else
            echo "Latest version: $version"
            echo "version=$version" >> $GITHUB_OUTPUT
          fi

      - name: Check for update
        id: check
        run: |
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.latest.outputs.version }}"
          echo "current_version=$current" >> $GITHUB_OUTPUT

          if [ -z "$current" ]; then
            echo "::error::Could not determine current version from spec file"
            exit 1
          fi

          if [ -z "$latest" ]; then
            echo "::warning::Could not fetch latest version from GitHub API, skipping update check"
            exit 0
          fi

          if [ "$current" != "$latest" ]; then
            echo "new_version=$latest" >> $GITHUB_OUTPUT
            echo "Update available: $current -> $latest"
          else
            echo "No update available (current: $current)"
          fi

  check-flux-core:
    name: Check flux-core updates
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          version=$(grep '^Version:' flux-core/flux-core.spec | awk '{print $2}')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Get latest release
        id: latest
        run: |
          response=$(curl -sf "https://api.github.com/repos/flux-framework/flux-core/releases?per_page=1") || {
            echo "Failed to fetch releases from GitHub API"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          }
          version=$(echo "$response" | jq -r '.[0].tag_name // empty' | sed 's/^v//')
          if [ -z "$version" ]; then
            echo "Could not parse version from GitHub API response"
            echo "version=" >> $GITHUB_OUTPUT
          else
            echo "Latest version: $version"
            echo "version=$version" >> $GITHUB_OUTPUT
          fi

      - name: Check for update
        id: check
        run: |
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.latest.outputs.version }}"
          echo "current_version=$current" >> $GITHUB_OUTPUT

          if [ -z "$current" ]; then
            echo "::error::Could not determine current version from spec file"
            exit 1
          fi

          if [ -z "$latest" ]; then
            echo "::warning::Could not fetch latest version from GitHub API, skipping update check"
            exit 0
          fi

          if [ "$current" != "$latest" ]; then
            echo "new_version=$latest" >> $GITHUB_OUTPUT
            echo "Update available: $current -> $latest"
          else
            echo "No update available (current: $current)"
          fi

  # ============================================================
  # Update jobs (only run if new version detected)
  # ============================================================

  # Check if pre-built container is available
  check-container:
    name: Check container availability
    runs-on: ubuntu-latest
    needs: [check-flux-security, check-flux-core]
    if: needs.check-flux-security.outputs.new_version != '' || needs.check-flux-core.outputs.new_version != ''
    outputs:
      image-to-use: ${{ steps.check.outputs.image }}
    steps:
      - name: Check if builder image exists
        id: check
        run: |
          if docker manifest inspect ${{ env.BUILDER_IMAGE }} > /dev/null 2>&1; then
            echo "image=${{ env.BUILDER_IMAGE }}" >> $GITHUB_OUTPUT
            echo "✅ Using pre-built container"
          else
            echo "image=fedora:latest" >> $GITHUB_OUTPUT
            echo "⚠️ Falling back to fedora:latest"
          fi

  update-flux-security:
    name: Update flux-security
    needs: [check-flux-security, check-container]
    if: needs.check-flux-security.outputs.new_version != ''
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.check-container.outputs.image-to-use }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (if using fallback image)
        run: |
          # Only install if not already present
          which cpio || dnf install -y cpio curl jq

      - name: Download new SRPM
        run: |
          VERSION="${{ needs.check-flux-security.outputs.new_version }}"
          ASSETS=$(curl -s "https://api.github.com/repos/flux-framework/flux-security/releases/tags/v${VERSION}")
          SRPM_URL=$(echo "$ASSETS" | jq -r '.assets[] | select(.name | endswith(".src.rpm")) | .browser_download_url' | head -1)
          if [ -n "$SRPM_URL" ] && [ "$SRPM_URL" != "null" ]; then
            curl -L -o flux-security.src.rpm "$SRPM_URL"
            rpm2cpio flux-security.src.rpm | cpio -idmv '*.spec'
            mv flux-security.spec flux-security/flux-security.spec.new
          else
            echo "No SRPM found, skipping"
            exit 0
          fi

      - name: Apply Fedora adaptations
        run: |
          if [ -f flux-security/flux-security.spec.new ]; then
            spec="flux-security/flux-security.spec.new"

            # SPDX License (Fedora 40+)
            sed -i 's/^License:.*/License: LGPL-3.0-only/' "$spec"

            # Full GitHub Source URL
            sed -i 's|^Source0:.*|Source0: %{url}/releases/download/v%{version}/%{name}-%{version}.tar.gz|' "$spec"

            # URL tag capitalization
            sed -i 's|^Url:|URL:|' "$spec"

            # Release tag with conditional dist
            sed -i 's/^Release:[[:space:]]*\([0-9]*\)%{dist}/Release: \1%{?dist}/' "$spec"

            # Remove deprecated tags
            sed -i '/^BuildRoot:/d' "$spec"
            sed -i '/^Group:/d' "$spec"
            sed -i '/%defattr/d' "$spec"
            sed -i '/^%clean$/,/^$/d' "$spec"

            # ldconfig scriptlets
            sed -i '/^%post[[:space:]]*-p[[:space:]]*\/sbin\/ldconfig/d' "$spec"
            sed -i '/^%postun[[:space:]]*-p[[:space:]]*\/sbin\/ldconfig/d' "$spec"

            # Remove debug package disabling
            sed -i '/^%define[[:space:]]*debug_package/d' "$spec"
            sed -i '/^%global[[:space:]]*debug_package/d' "$spec"
            sed -i '/^%define[[:space:]]*__spec_install_post/d' "$spec"
            sed -i '/^%global[[:space:]]*__spec_install_post/d' "$spec"

            # Python package naming
            sed -i 's/python3-yaml/python3-pyyaml/g' "$spec"

            # Remove LLNL-specific configs
            sed -i '/^%define[[:space:]]*python3_sitearch/d' "$spec"
            sed -i '/^%global[[:space:]]*python3_sitearch/d' "$spec"
            sed -i '/^BuildRequires:[[:space:]]*python3\.[0-9]/d' "$spec"
            sed -i '/0%{?bl6}/,/%endif/d' "$spec"
            sed -i '/0%{?toss}/,/%endif/d' "$spec"

            # Remove custom CFLAGS/LDFLAGS
            sed -i '/^CFLAGS=/d' "$spec"
            sed -i '/^LDFLAGS=/d' "$spec"
            sed -i '/^export CFLAGS/d' "$spec"
            sed -i '/^export LDFLAGS/d' "$spec"

            # Remove LLNL patches
            sed -i '/^Patch[0-9]*:/d' "$spec"
            sed -i '/^%patch[0-9]/d' "$spec"

            # Remove pip-based sphinx
            sed -i '/pip3[[:space:]]*install.*sphinx/d' "$spec"
            sed -i '/pip[[:space:]]*install.*sphinx/d' "$spec"
            sed -i '/^BuildRequires:[[:space:]]*python3-pip/d' "$spec"

            # Modern build macros
            sed -i 's/make[[:space:]]*%{?_smp_mflags}/%make_build/g' "$spec"
            sed -i 's/make[[:space:]]*%{_smp_mflags}/%make_build/g' "$spec"

            # Path variables
            sed -i 's/\${RPM_BUILD_ROOT}/%{buildroot}/g' "$spec"
            sed -i 's/\$RPM_BUILD_ROOT/%{buildroot}/g' "$spec"

            # Use %global
            sed -i 's/^%define /%global /' "$spec"

            # Update Summary
            sed -i 's/^Summary:.*Flux Resource Manager Framework.*/Summary: Flux Framework Security Components/' "$spec"

            # Cleanup
            sed -i 's/[[:space:]]*$//' "$spec"

            mv "$spec" flux-security/flux-security.spec
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update flux-security to ${{ needs.check-flux-security.outputs.new_version }}"
          title: "Update flux-security to ${{ needs.check-flux-security.outputs.new_version }}"
          body: |
            Automated update of flux-security from ${{ needs.check-flux-security.outputs.current_version }} to ${{ needs.check-flux-security.outputs.new_version }}.

            Release: https://github.com/flux-framework/flux-security/releases/tag/v${{ needs.check-flux-security.outputs.new_version }}

            ## Fedora Adaptations Applied

            - SPDX License identifier (`LGPL-3.0-only`)
            - Full GitHub Source URL
            - Removed deprecated tags (BuildRoot, Group, %defattr, %clean)
            - Modern ldconfig scriptlets
            - Removed LLNL-specific patches and conditionals
            - Modern build macros (`%make_build`, `%make_install`)

            Please review the spec file changes and ensure Fedora compatibility.
          branch: update-flux-security-${{ needs.check-flux-security.outputs.new_version }}
          delete-branch: true

  update-flux-core:
    name: Update flux-core
    needs: [check-flux-core, check-container]
    if: needs.check-flux-core.outputs.new_version != ''
    runs-on: ubuntu-latest
    container:
      image: ${{ needs.check-container.outputs.image-to-use }}
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (if using fallback image)
        run: |
          which cpio || dnf install -y cpio curl jq

      - name: Download new SRPM
        run: |
          VERSION="${{ needs.check-flux-core.outputs.new_version }}"
          ASSETS=$(curl -s "https://api.github.com/repos/flux-framework/flux-core/releases/tags/v${VERSION}")
          SRPM_URL=$(echo "$ASSETS" | jq -r '.assets[] | select(.name | endswith(".src.rpm")) | .browser_download_url' | head -1)
          if [ -n "$SRPM_URL" ] && [ "$SRPM_URL" != "null" ]; then
            curl -L -o flux-core.src.rpm "$SRPM_URL"
            rpm2cpio flux-core.src.rpm | cpio -idmv '*.spec'
            mv flux-core.spec flux-core/flux-core.spec.new
          else
            echo "No SRPM found, skipping"
            exit 0
          fi

      - name: Apply Fedora adaptations
        run: |
          if [ -f flux-core/flux-core.spec.new ]; then
            spec="flux-core/flux-core.spec.new"

            # SPDX License (Fedora 40+)
            sed -i 's/^License:.*/License: LGPL-3.0-only/' "$spec"

            # Full GitHub Source URL
            sed -i 's|^Source0:.*|Source0: %{url}/releases/download/v%{version}/%{name}-%{version}.tar.gz|' "$spec"

            # URL tag capitalization
            sed -i 's|^Url:|URL:|' "$spec"

            # Release tag with conditional dist
            sed -i 's/^Release:[[:space:]]*\([0-9]*\)%{dist}/Release: \1%{?dist}/' "$spec"

            # Remove deprecated tags
            sed -i '/^BuildRoot:/d' "$spec"
            sed -i '/^Group:/d' "$spec"
            sed -i '/%defattr/d' "$spec"
            sed -i '/^%clean$/,/^$/d' "$spec"

            # ldconfig scriptlets
            sed -i '/^%post[[:space:]]*-p[[:space:]]*\/sbin\/ldconfig/d' "$spec"
            sed -i '/^%postun[[:space:]]*-p[[:space:]]*\/sbin\/ldconfig/d' "$spec"

            # Remove debug package disabling
            sed -i '/^%define[[:space:]]*debug_package/d' "$spec"
            sed -i '/^%global[[:space:]]*debug_package/d' "$spec"
            sed -i '/^%define[[:space:]]*__spec_install_post/d' "$spec"
            sed -i '/^%global[[:space:]]*__spec_install_post/d' "$spec"

            # Python package naming
            sed -i 's/python3-yaml/python3-pyyaml/g' "$spec"

            # Remove LLNL-specific configs
            sed -i '/^%define[[:space:]]*python3_sitearch/d' "$spec"
            sed -i '/^%global[[:space:]]*python3_sitearch/d' "$spec"
            sed -i '/^BuildRequires:[[:space:]]*python3\.[0-9]/d' "$spec"
            sed -i '/^%package[[:space:]]*python3\.[0-9]/,/^%package\|^%prep/d' "$spec"
            sed -i '/^%description[[:space:]]*python3\.[0-9]/,/^%package\|^%description\|^%prep/d' "$spec"
            sed -i '/^%files[[:space:]]*python3\.[0-9]/,/^%files\|^%changelog/d' "$spec"
            sed -i '/0%{?bl6}/,/%endif/d' "$spec"
            sed -i '/0%{?toss}/,/%endif/d' "$spec"

            # Remove custom CFLAGS/LDFLAGS
            sed -i '/^CFLAGS=/d' "$spec"
            sed -i '/^LDFLAGS=/d' "$spec"
            sed -i '/^export CFLAGS/d' "$spec"
            sed -i '/^export LDFLAGS/d' "$spec"

            # Remove LLNL patches
            sed -i '/^Patch[0-9]*:/d' "$spec"
            sed -i '/^%patch[0-9]/d' "$spec"

            # Remove pip-based sphinx
            sed -i '/pip3[[:space:]]*install.*sphinx/d' "$spec"
            sed -i '/pip[[:space:]]*install.*sphinx/d' "$spec"
            sed -i '/^BuildRequires:[[:space:]]*python3-pip/d' "$spec"

            # Modern build macros
            sed -i 's/make[[:space:]]*%{?_smp_mflags}/%make_build/g' "$spec"
            sed -i 's/make[[:space:]]*%{_smp_mflags}/%make_build/g' "$spec"

            # Path variables
            sed -i 's/\${RPM_BUILD_ROOT}/%{buildroot}/g' "$spec"
            sed -i 's/\$RPM_BUILD_ROOT/%{buildroot}/g' "$spec"

            # Use %global
            sed -i 's/^%define /%global /' "$spec"

            # Use flux-security-devel
            sed -i 's/^BuildRequires:[[:space:]]*flux-security[[:space:]]*>=/BuildRequires: flux-security-devel >=/' "$spec"

            # Cleanup
            sed -i 's/[[:space:]]*$//' "$spec"

            mv "$spec" flux-core/flux-core.spec
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update flux-core to ${{ needs.check-flux-core.outputs.new_version }}"
          title: "Update flux-core to ${{ needs.check-flux-core.outputs.new_version }}"
          body: |
            Automated update of flux-core from ${{ needs.check-flux-core.outputs.current_version }} to ${{ needs.check-flux-core.outputs.new_version }}.

            Release: https://github.com/flux-framework/flux-core/releases/tag/v${{ needs.check-flux-core.outputs.new_version }}

            ## Fedora Adaptations Applied

            - SPDX License identifier (`LGPL-3.0-only`)
            - Full GitHub Source URL
            - Removed deprecated tags (BuildRoot, Group, %defattr, %clean)
            - Modern ldconfig scriptlets
            - Removed versioned Python subpackages (use `python3-flux`)
            - Removed LLNL-specific patches and conditionals
            - Modern build macros (`%make_build`, `%make_install`)
            - Corrected `flux-security-devel` dependency

            Please review the spec file changes and ensure Fedora compatibility.
          branch: update-flux-core-${{ needs.check-flux-core.outputs.new_version }}
          delete-branch: true
