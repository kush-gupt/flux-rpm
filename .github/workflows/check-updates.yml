name: Check for Updates

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

jobs:
  check-flux-security:
    name: Check flux-security updates
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          version=$(grep '^Version:' flux-security/flux-security.spec | awk '{print $2}')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Get latest release
        id: latest
        run: |
          # Note: flux-framework marks all releases as prereleases, so /releases/latest returns 404
          # Instead, fetch from /releases and get the first (most recent) release
          response=$(curl -sf "https://api.github.com/repos/flux-framework/flux-security/releases?per_page=1") || {
            echo "Failed to fetch releases from GitHub API"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          }
          version=$(echo "$response" | jq -r '.[0].tag_name // empty' | sed 's/^v//')
          if [ -z "$version" ]; then
            echo "Could not parse version from GitHub API response"
            echo "version=" >> $GITHUB_OUTPUT
          else
            echo "Latest version: $version"
            echo "version=$version" >> $GITHUB_OUTPUT
          fi

      - name: Check for update
        id: check
        run: |
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.latest.outputs.version }}"
          echo "current_version=$current" >> $GITHUB_OUTPUT

          # Validate we have both versions
          if [ -z "$current" ]; then
            echo "::error::Could not determine current version from spec file"
            exit 1
          fi

          if [ -z "$latest" ]; then
            echo "::warning::Could not fetch latest version from GitHub API, skipping update check"
            echo "No update available (API fetch failed)"
            exit 0
          fi

          # Check if versions differ
          if [ "$current" != "$latest" ]; then
            echo "new_version=$latest" >> $GITHUB_OUTPUT
            echo "Update available: $current -> $latest"
          else
            echo "No update available (current: $current)"
          fi

  check-flux-core:
    name: Check flux-core updates
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      current_version: ${{ steps.check.outputs.current_version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get current version
        id: current
        run: |
          version=$(grep '^Version:' flux-core/flux-core.spec | awk '{print $2}')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Get latest release
        id: latest
        run: |
          # Note: flux-framework marks all releases as prereleases, so /releases/latest returns 404
          # Instead, fetch from /releases and get the first (most recent) release
          response=$(curl -sf "https://api.github.com/repos/flux-framework/flux-core/releases?per_page=1") || {
            echo "Failed to fetch releases from GitHub API"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          }
          version=$(echo "$response" | jq -r '.[0].tag_name // empty' | sed 's/^v//')
          if [ -z "$version" ]; then
            echo "Could not parse version from GitHub API response"
            echo "version=" >> $GITHUB_OUTPUT
          else
            echo "Latest version: $version"
            echo "version=$version" >> $GITHUB_OUTPUT
          fi

      - name: Check for update
        id: check
        run: |
          current="${{ steps.current.outputs.version }}"
          latest="${{ steps.latest.outputs.version }}"
          echo "current_version=$current" >> $GITHUB_OUTPUT

          # Validate we have both versions
          if [ -z "$current" ]; then
            echo "::error::Could not determine current version from spec file"
            exit 1
          fi

          if [ -z "$latest" ]; then
            echo "::warning::Could not fetch latest version from GitHub API, skipping update check"
            echo "No update available (API fetch failed)"
            exit 0
          fi

          # Check if versions differ
          if [ "$current" != "$latest" ]; then
            echo "new_version=$latest" >> $GITHUB_OUTPUT
            echo "Update available: $current -> $latest"
          else
            echo "No update available (current: $current)"
          fi

  update-flux-security:
    name: Update flux-security
    needs: check-flux-security
    if: needs.check-flux-security.outputs.new_version != ''
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: dnf install -y cpio curl jq

      - name: Download new SRPM
        run: |
          VERSION="${{ needs.check-flux-security.outputs.new_version }}"
          ASSETS=$(curl -s "https://api.github.com/repos/flux-framework/flux-security/releases/tags/v${VERSION}")
          SRPM_URL=$(echo "$ASSETS" | jq -r '.assets[] | select(.name | endswith(".src.rpm")) | .browser_download_url' | head -1)
          if [ -n "$SRPM_URL" ] && [ "$SRPM_URL" != "null" ]; then
            curl -L -o flux-security.src.rpm "$SRPM_URL"
            rpm2cpio flux-security.src.rpm | cpio -idmv '*.spec'
            mv flux-security.spec flux-security/flux-security.spec.new
          else
            echo "No SRPM found, skipping"
            exit 0
          fi

      - name: Apply Fedora adaptations
        run: |
          if [ -f flux-security/flux-security.spec.new ]; then
            spec="flux-security/flux-security.spec.new"

            # ================================================================
            # REQUIRED CHANGES (per FEDORA_CHANGES.md)
            # ================================================================

            # 1. SPDX License (Fedora 40+)
            sed -i 's/^License:.*/License: LGPL-3.0-only/' "$spec"

            # 2. Full GitHub Source URL
            sed -i 's|^Source0:.*|Source0: %{url}/releases/download/v%{version}/%{name}-%{version}.tar.gz|' "$spec"

            # 3. URL tag capitalization
            sed -i 's|^Url:|URL:|' "$spec"

            # 4. Release tag with conditional dist
            sed -i 's/^Release:[[:space:]]*\([0-9]*\)%{dist}/Release: \1%{?dist}/' "$spec"

            # 5. Remove deprecated BuildRoot tag
            sed -i '/^BuildRoot:/d' "$spec"

            # 6. Remove deprecated Group tag
            sed -i '/^Group:/d' "$spec"

            # 7. Remove deprecated %defattr
            sed -i '/%defattr/d' "$spec"

            # 8. Remove deprecated %clean section
            sed -i '/^%clean$/,/^$/d' "$spec"

            # 9. ldconfig scriptlets
            sed -i '/^%post[[:space:]]*-p[[:space:]]*\/sbin\/ldconfig/d' "$spec"
            sed -i '/^%postun[[:space:]]*-p[[:space:]]*\/sbin\/ldconfig/d' "$spec"

            # 10. Remove debug package disabling
            sed -i '/^%define[[:space:]]*debug_package/d' "$spec"
            sed -i '/^%global[[:space:]]*debug_package/d' "$spec"
            sed -i '/^%define[[:space:]]*__spec_install_post/d' "$spec"
            sed -i '/^%global[[:space:]]*__spec_install_post/d' "$spec"

            # 11. Python package naming
            sed -i 's/python3-yaml/python3-pyyaml/g' "$spec"

            # 12-14. Remove LLNL multi-Python setup
            sed -i '/^%define[[:space:]]*python3_sitearch/d' "$spec"
            sed -i '/^%global[[:space:]]*python3_sitearch/d' "$spec"
            sed -i '/^%define[[:space:]]*python3[0-9]*_sitearch/d' "$spec"
            sed -i '/^%global[[:space:]]*python3[0-9]*_sitearch/d' "$spec"
            sed -i '/^BuildRequires:[[:space:]]*python3\.[0-9]/d' "$spec"

            # 15. Remove LLNL conditionals
            sed -i '/0%{?bl6}/,/%endif/d' "$spec"
            sed -i '/0%{?toss}/,/%endif/d' "$spec"

            # 16. Remove custom CFLAGS blocks
            sed -i '/^CFLAGS=/d' "$spec"
            sed -i '/^LDFLAGS=/d' "$spec"
            sed -i '/^export CFLAGS/d' "$spec"
            sed -i '/^export LDFLAGS/d' "$spec"
            sed -i '/^CFLAGS="${KOJI_CFLAGS}"/d' "$spec"

            # 17. Remove LLNL-specific patches
            sed -i '/^Patch[0-9]*:/d' "$spec"
            sed -i '/^%patch[0-9]/d' "$spec"

            # 18. Remove pip-based sphinx installation
            sed -i '/pip3[[:space:]]*install.*sphinx\|requirements\.txt/d' "$spec"
            sed -i '/pip[[:space:]]*install.*sphinx\|requirements\.txt/d' "$spec"
            sed -i '/export PATH=\$HOME\/.local\/bin:\$PATH/d' "$spec"

            # 19. Remove pip BuildRequires
            sed -i '/^BuildRequires:[[:space:]]*python3-pip/d' "$spec"
            sed -i '/^BuildRequires:[[:space:]]*python3\.[0-9]*-pip/d' "$spec"

            # 20. Modern build macros
            sed -i 's/make[[:space:]]*%{?_smp_mflags}/%make_build/g' "$spec"
            sed -i 's/make[[:space:]]*%{_smp_mflags}/%make_build/g' "$spec"
            sed -i 's/make[[:space:]]*install[[:space:]]*DESTDIR=[^[:space:]]*/\%make_install/g' "$spec"
            sed -i 's/make[[:space:]]*DESTDIR=[^[:space:]]*[[:space:]]*install/%make_install/g' "$spec"

            # 21. Path variables
            sed -i 's/\${RPM_BUILD_ROOT}/%{buildroot}/g' "$spec"
            sed -i 's/\$RPM_BUILD_ROOT/%{buildroot}/g' "$spec"

            # 22. Use %global instead of %define
            sed -i 's/^%define /%global /' "$spec"

            # 23. Fix double-slash typo
            sed -i 's|flux//system|flux/system|g' "$spec"

            # 24. Improve error suppression in chrpath
            sed -i 's/xargs[[:space:]]*-ti[[:space:]]*chrpath/xargs -I{} chrpath -d {} 2>\/dev\/null || true/g' "$spec"

            # 25. Improve systemctl check
            sed -i 's|systemctl is-active --quiet|systemctl is-active --quiet 2>/dev/null|g' "$spec"

            # Package-specific: Update Summary
            sed -i 's/^Summary:.*Flux Resource Manager Framework.*/Summary: Flux Framework Security Components/' "$spec"

            # Cleanup
            sed -i 's/[[:space:]]*$//' "$spec"

            mv "$spec" flux-security/flux-security.spec
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update flux-security to ${{ needs.check-flux-security.outputs.new_version }}"
          title: "Update flux-security to ${{ needs.check-flux-security.outputs.new_version }}"
          body: |
            Automated update of flux-security from ${{ needs.check-flux-security.outputs.current_version }} to ${{ needs.check-flux-security.outputs.new_version }}.

            Release: https://github.com/flux-framework/flux-security/releases/tag/v${{ needs.check-flux-security.outputs.new_version }}

            ## Fedora Adaptations Applied

            The following adaptations from `FEDORA_CHANGES.md` have been automatically applied:
            - SPDX License identifier (`LGPL-3.0-only`)
            - Full GitHub Source URL
            - URL tag capitalization
            - Conditional dist tag (`%{?dist}`)
            - Removed deprecated tags (BuildRoot, Group, %defattr, %clean)
            - Modern ldconfig scriptlets
            - Debug packages enabled (default)
            - Python package naming fixes
            - Removed LLNL-specific patches and conditionals
            - Modern build macros (`%make_build`, `%make_install`)
            - Path variable standardization (`%{buildroot}`)

            Please review the spec file changes and ensure Fedora compatibility.
          branch: update-flux-security-${{ needs.check-flux-security.outputs.new_version }}
          delete-branch: true

  update-flux-core:
    name: Update flux-core
    needs: check-flux-core
    if: needs.check-flux-core.outputs.new_version != ''
    runs-on: ubuntu-latest
    container:
      image: fedora:latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: dnf install -y cpio curl jq

      - name: Download new SRPM
        run: |
          VERSION="${{ needs.check-flux-core.outputs.new_version }}"
          ASSETS=$(curl -s "https://api.github.com/repos/flux-framework/flux-core/releases/tags/v${VERSION}")
          SRPM_URL=$(echo "$ASSETS" | jq -r '.assets[] | select(.name | endswith(".src.rpm")) | .browser_download_url' | head -1)
          if [ -n "$SRPM_URL" ] && [ "$SRPM_URL" != "null" ]; then
            curl -L -o flux-core.src.rpm "$SRPM_URL"
            rpm2cpio flux-core.src.rpm | cpio -idmv '*.spec'
            mv flux-core.spec flux-core/flux-core.spec.new
          else
            echo "No SRPM found, skipping"
            exit 0
          fi

      - name: Apply Fedora adaptations
        run: |
          if [ -f flux-core/flux-core.spec.new ]; then
            spec="flux-core/flux-core.spec.new"

            # ================================================================
            # REQUIRED CHANGES (per FEDORA_CHANGES.md)
            # ================================================================

            # 1. SPDX License (Fedora 40+)
            sed -i 's/^License:.*/License: LGPL-3.0-only/' "$spec"

            # 2. Full GitHub Source URL
            sed -i 's|^Source0:.*|Source0: %{url}/releases/download/v%{version}/%{name}-%{version}.tar.gz|' "$spec"

            # 3. URL tag capitalization
            sed -i 's|^Url:|URL:|' "$spec"

            # 4. Release tag with conditional dist
            sed -i 's/^Release:[[:space:]]*\([0-9]*\)%{dist}/Release: \1%{?dist}/' "$spec"

            # 5. Remove deprecated BuildRoot tag
            sed -i '/^BuildRoot:/d' "$spec"

            # 6. Remove deprecated Group tag
            sed -i '/^Group:/d' "$spec"

            # 7. Remove deprecated %defattr
            sed -i '/%defattr/d' "$spec"

            # 8. Remove deprecated %clean section
            sed -i '/^%clean$/,/^$/d' "$spec"

            # 9. ldconfig scriptlets
            sed -i '/^%post[[:space:]]*-p[[:space:]]*\/sbin\/ldconfig/d' "$spec"
            sed -i '/^%postun[[:space:]]*-p[[:space:]]*\/sbin\/ldconfig/d' "$spec"

            # 10. Remove debug package disabling
            sed -i '/^%define[[:space:]]*debug_package/d' "$spec"
            sed -i '/^%global[[:space:]]*debug_package/d' "$spec"
            sed -i '/^%define[[:space:]]*__spec_install_post/d' "$spec"
            sed -i '/^%global[[:space:]]*__spec_install_post/d' "$spec"

            # 11. Python package naming
            sed -i 's/python3-yaml/python3-pyyaml/g' "$spec"

            # 12-14. Remove LLNL multi-Python setup
            sed -i '/^%define[[:space:]]*python3_sitearch/d' "$spec"
            sed -i '/^%global[[:space:]]*python3_sitearch/d' "$spec"
            sed -i '/^%define[[:space:]]*python3[0-9]*_sitearch/d' "$spec"
            sed -i '/^%global[[:space:]]*python3[0-9]*_sitearch/d' "$spec"
            sed -i '/^BuildRequires:[[:space:]]*python3\.[0-9]/d' "$spec"
            # Remove versioned python packages
            sed -i '/^%package[[:space:]]*python3\.[0-9]/,/^%package\|^%prep/d' "$spec"
            sed -i '/^%description[[:space:]]*python3\.[0-9]/,/^%package\|^%description\|^%prep/d' "$spec"
            sed -i '/^%files[[:space:]]*python3\.[0-9]/,/^%files\|^%changelog/d' "$spec"

            # 15. Remove LLNL conditionals
            sed -i '/0%{?bl6}/,/%endif/d' "$spec"
            sed -i '/0%{?toss}/,/%endif/d' "$spec"

            # 16. Remove custom CFLAGS blocks
            sed -i '/^CFLAGS=/d' "$spec"
            sed -i '/^LDFLAGS=/d' "$spec"
            sed -i '/^export CFLAGS/d' "$spec"
            sed -i '/^export LDFLAGS/d' "$spec"
            sed -i '/^CFLAGS="${KOJI_CFLAGS}"/d' "$spec"

            # 17. Remove LLNL-specific patches
            sed -i '/^Patch[0-9]*:/d' "$spec"
            sed -i '/^%patch[0-9]/d' "$spec"

            # 18. Remove pip-based sphinx installation
            sed -i '/pip3[[:space:]]*install.*sphinx\|requirements\.txt/d' "$spec"
            sed -i '/pip[[:space:]]*install.*sphinx\|requirements\.txt/d' "$spec"
            sed -i '/export PATH=\$HOME\/.local\/bin:\$PATH/d' "$spec"

            # 19. Remove pip BuildRequires
            sed -i '/^BuildRequires:[[:space:]]*python3-pip/d' "$spec"
            sed -i '/^BuildRequires:[[:space:]]*python3\.[0-9]*-pip/d' "$spec"

            # 20. Modern build macros
            sed -i 's/make[[:space:]]*%{?_smp_mflags}/%make_build/g' "$spec"
            sed -i 's/make[[:space:]]*%{_smp_mflags}/%make_build/g' "$spec"
            sed -i 's/make[[:space:]]*install[[:space:]]*DESTDIR=[^[:space:]]*/\%make_install/g' "$spec"
            sed -i 's/make[[:space:]]*DESTDIR=[^[:space:]]*[[:space:]]*install/%make_install/g' "$spec"

            # 21. Path variables
            sed -i 's/\${RPM_BUILD_ROOT}/%{buildroot}/g' "$spec"
            sed -i 's/\$RPM_BUILD_ROOT/%{buildroot}/g' "$spec"

            # 22. Use %global instead of %define
            sed -i 's/^%define /%global /' "$spec"

            # 23. Fix double-slash typo
            sed -i 's|flux//system|flux/system|g' "$spec"

            # 24. Improve error suppression in chrpath
            sed -i 's/xargs[[:space:]]*-ti[[:space:]]*chrpath/xargs -I{} chrpath -d {} 2>\/dev\/null || true/g' "$spec"

            # 25. Improve systemctl check
            sed -i 's|systemctl is-active --quiet|systemctl is-active --quiet 2>/dev/null|g' "$spec"

            # Package-specific: Use flux-security-devel
            sed -i 's/^BuildRequires:[[:space:]]*flux-security[[:space:]]*>=/BuildRequires: flux-security-devel >=/' "$spec"

            # Cleanup
            sed -i 's/[[:space:]]*$//' "$spec"

            mv "$spec" flux-core/flux-core.spec
          fi

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update flux-core to ${{ needs.check-flux-core.outputs.new_version }}"
          title: "Update flux-core to ${{ needs.check-flux-core.outputs.new_version }}"
          body: |
            Automated update of flux-core from ${{ needs.check-flux-core.outputs.current_version }} to ${{ needs.check-flux-core.outputs.new_version }}.

            Release: https://github.com/flux-framework/flux-core/releases/tag/v${{ needs.check-flux-core.outputs.new_version }}

            ## Fedora Adaptations Applied

            The following adaptations from `FEDORA_CHANGES.md` have been automatically applied:
            - SPDX License identifier (`LGPL-3.0-only`)
            - Full GitHub Source URL
            - URL tag capitalization
            - Conditional dist tag (`%{?dist}`)
            - Removed deprecated tags (BuildRoot, Group, %defattr, %clean)
            - Modern ldconfig scriptlets
            - Debug packages enabled (default)
            - Python package naming fixes (`python3-pyyaml`)
            - Removed versioned Python subpackages (use `python3-flux`)
            - Removed LLNL-specific patches and conditionals
            - Modern build macros (`%make_build`, `%make_install`)
            - Path variable standardization (`%{buildroot}`)
            - Corrected `flux-security-devel` dependency

            Please review the spec file changes and ensure Fedora compatibility.
          branch: update-flux-core-${{ needs.check-flux-core.outputs.new_version }}
          delete-branch: true
